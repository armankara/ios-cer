version: '2.1'
orbs:
  unity: game-ci/unity@0.2.0
  ruby: circleci/ruby@1.2.0

jobs:
  -
    build:
      build-target: iOS
      context: unity-orb
      executor:
        editor_version: 2019.4.19f1
        name: unity/ubuntu
        resource_class: large
        target_platform: ios
      name: build-ios
      project-path: ./
      step-name: "Build iOS"
      unity-license-var-name: UNITY_ENCODED_LICENSE
  -
    save_cache:
      key: ios-build-workspace
      paths:
        - builds/ios
  -
    test-flight:
      macos:
        xcode: "13.4.1"
      name: test-flight
      steps:
        -
          keys: ios-build-workspace
          restore_cache: ~
        - ruby/install-deps
        -
          run:
            command: "bundle exec fastlane beta"
            name: fastlane
      working_directory: ./
workflows:
  build-ios:
    jobs:
      - checkout
      - build
      - test-flight
